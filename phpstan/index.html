<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>Analyse statique avec PHPStan</title>

        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/white.css">

        <!-- Theme used for syntax highlighting of code -->
        <link rel="stylesheet" href="lib/css/tomorrow.css">
        <!--
        <link rel="stylesheet" href="lib/css/atom-one-light.css">
        <link rel="stylesheet" href="lib/css/default.css">
        <link rel="stylesheet" href="lib/css/github.css">
        <link rel="stylesheet" href="lib/css/github-gist.css">
        -->
        <link rel="stylesheet" href="css/phpstan.css">

        <!-- Printing and PDF exports -->
        <script>
var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                <section data-markdown>
                    <script type="text/template">
## Explorez votre code avec de l'analyse statique
                    </script>
                </section>

                <section>
                <section id="my-name-is">
                    <p>Je m'appelle Julien Deniau</p>
                    <p>
                        Je suis un vieux‚Ä¶
                        <span class="fragment fade-left" style="display: inline-block;">
                            codeur
                        </span>
                    </p>
                </section>

                <section>
                    <p>J'ai cod√© mes premiers sites :</p>
                    <ul>
                        <li>sur membres.lycos.fr</li>
                        <li>en PHP 3</li>
                        <li>avec Macromedia Dreamweaver</li>
                    </ul>

                    <aside class="notes">
                        Sortie de PHP 4 : Mai 2000<br />
                        Sortie de PHP 5 : Juillet 2004
                    </aside>
                </section>

                <section id="aventure">
                    <ul>
                    <li>Pas de fichier ".h" du C</li>
                    <li>Pas de `System.out.println()` du Java</li>
                    <li>
                    <pre><code class="hljs php" data-trim>
                    echo '&lt;html&gt;'; // et c'est parti !
                    </code></pre>
                    </li>
                    </ul>

                    <h3 class="fragment">
                        <br />
                    Bref, PHP c'√©tait l'aventure
                    </h3>
                </section>
                </section>

                <section>
                <section
                    id="israel"
                    data-background-image="images/assassins-creed-jerusalem.jpg"
                    data-background-size="contain"
                >
                    <!--
                    <p>Bon c'est vrai, des fois il fallait comprendre</p>
                    -->
                    <blockquote style="background: rgba(255, 255, 255, 0.8)">
                        Parse error: syntax error, unexpected T_PAAMAYIM_NEKUDOTAYIM
                    </blockquote>

                    <aside class="notes">
                        L'impression d'√™tre Alta√Ør dans Assassin's Creed<br />

                        <br />
                        <i>Nom officiel de l'op√©rateur de r√©solution de port√©e (::) utilis√© en PHP pour acc√©der aux membres statiques ou constants d'une classe.<br />
                            Il s'utilise par la syntaxe `Classe::Element`</i>
                    </aside>

                </section>

                <section
                    id="unexpected-variable"
                    data-background-image="images/indi-x.jpg"
                    data-background-size="contain"
                >
                    <blockquote style="background: rgba(255, 255, 255, 0.8)">
                    PHP Parse error: syntax error, unexpected '$a' (T_VARIABLE) on line 6
                    </blockquote>
                    <aside class="notes">
                        Quel plaisir de fouiller pour trouver qu'en fait, il fallait regarder la ligne 5 !
                    </aside>
                </section>

                <section
                    id="freedom"
                    data-background-image="images/tomb-raider.png"
                    data-background-opacity="0.6"
                    data-background-size="contain"
                >
                    <h2>Mais la libert√© du langage √©tait tellement belle...</h2>
                </section>

                <section id="">
                        PHP Fatal error: Uncaught Error:<br />
                        Call to a member function getTitle() on null
                    
                    <aside class="notes">
                        oui bon OK, ap 10 ans d'aventures, quelques versions de PHP, et quelques lignes de codes plus tard, je me suis rendu compte que je n'√©tais pas un aventurier

                    </aside>
                </section>
                </section>

                <section>
                <section>
                    <p>
                        üëç 
                        voyager
                    </p>
                    <p>
                        ‚ô•
                        avec un compas
                    </p>
                    <aside class="notes">
                        J'aime voyager, mais j'aime avoir un compas pour me guider ; (une carte ?)
                    </aside>
                </section>

                <section>
                    <p>
                         üëç
                         d√©couvrir
                    </p>
                    <p>
                    ‚ô•
                        comprendre avec un dictionnaire
                    </p>
                    <aside class="notes">
                        J'aime d√©couvrir, mais j‚Äôappr√©cie avoir une pierre philosophale pour comprendre ; (un dictionnaire ?)
                    </aside>
                </section>
                <section
                    id="manuel"
                >
                    <p>
                        üëç
                        construire
                    </p>
                    <p>
                        ‚ô•
                        manuel
                    </p>
                    <p>
                    <img src="images/ikea.jpg" />
                    </p>
                </section>
                </section>

                <section>
                <section id="explorer">
                    <h3>
                        <p>
                        <strike>
                            Je suis un aventurier
                        </strike>
                        </p>
                        <p>
                            Je suis un explorateur.
                        </p>
                    </h3>

                </section>

                <section>
                    <p>
                    <strong>Aventurier :</strong> seul avec ses bytes et son couteau
                    </p>
                    <p class="fragment">
                    <strong>Explorateur :</strong> Aller fouiller avec les outils adapt√©s
                    </p>
                </section>
                </section>

                <section>
                    <section id="tests">
                        <h2>Les outils<br /></h2>
                        <div class="round-container">
                            <div class="round-tests">
                                Tests
                            </div>
                            <div class="round-blank"></div>
                        </div>
                        <aside class="notes">
                            <ul>
                                <li> Les tests servent √† valider qu'un syst√®me fonctionne
                                <li> Ils √©vitent les r√©gressions
                                <li> Ils ne doivent pas servir √† tester du code qui ne compilerait m√™me pas dans un autre langage (tester qu'une erreur est bien retourn√©e si on envoie `null` ou le mauvais type)
                                    <li> PHP est "permissif", mais peut du coup amener des comportements √©trange, ou bien un grand nombre de ligne de code inutile
                            </ul>
                        </aside>
                    </section>

                    <section>
                        <p>PHP 7 : structuration du langage, typage statique</p>
                        <p>Plus de m√©thode avec param√®tre inconnu !</p>
                        <div class="fragment">
                            <br />
                            <pre><code class="hljs shell" data-trim>
                                Type error: Argument 1 passed to slugify()
                                must be of the type string or null, integer given
                            </code></pre>
                            ‚Üì
                            <div>
                                Fatal en prod !
                            </div>
                        </div>

                        <aside class="notes">
                            Au fur et √† mesure des versions de PHP, le langage se "structure" de plus en plus,<br />
                            et int√®gre du typage statique.<br />
                            C'est bien ! Plus de m√©thode avec param√®tres inconnu...<br />
                            <br />
                            `Type error` ‚Üí Fatar erreur en prod !
                        </aside>
                    </section>
                </section>

                <section id="tools">
                    <h2>Les outils<br /></h2>
                    <div class="round-container">
                        <div class="round-tests">
                            Tests
                        </div>
                        <div class="round-phpstan fragment">
                            Analyse <br />
                            statique
                        </div>
                    </div>
                </section>

                <section id="static-analyzer">
                    <section>
                        <ul>
                            <li>Analyseur : Il "lit" le code,
                            <li>Statique : il n'ex√©cute pas le programme
                        </ul>
                    </section>

                    <section>
                        <h2>Des dizaines d'analyseurs statiques</h2>
                        <div> 
                            <img data-src="/images/GitHub-Mark.png" width="150px" class="image-like-text" />
                            <a href="https://github.com/exakat/php-static-analysis-tools" rel="noopener noreferer" target="_blank">
                                exakat/php-static-analysis-tools
                            </a>
                        </div>
                        <aside class="notes">
                            <ul>
                                <li> D√©tection de code mort, de bugs,
                                <li> linter,
                                <li> standard de code,
                                <li> m√©triques,
                                <li> etc.
                            </ul>
                        </aside>
                    </section>

                    <section id="phpstan">
                        <h2>PHPStan</h2>
                        <h3>PHP Static Analysis Tool</h3>
                    </section>

                    <section>
                        <h2>PHPStan n'est pas</h2>
                        <ul>
                            <li>Un framework de test,
                            <li>Du code qui s'ex√©cute,
                            <li>Magique : il ne devine pas ce que vous ne lui dites pas
                        </ul>

                        <aside class="notes">
                        <ul>
                            <li>Un framework de test (unitaire, fonctionnel, ou autre),<br />
                                D'ailleurs, il va vous permettre de trouver des bugs sans √©crire de tests suppl√©mentaire
                            <li>Du code qui s'ex√©cute (vous attendez un string, vous envoyez un tableau, il ne va pas "prendre la main" pour envoyer une exception avant la fatal PHP),
                            <li>Magique : il ne devine pas ce que vous ne lui dites pas
                        </ul>
                        </aside>
                    </section>

                    <section>
                        <pre><code class="hljs php" data-trim data-noescape>class Foo {
    <span class="fragment highlight-red" data-fragment-index="3">private $bar; <span class="fragment" data-fragment-index="3"> // consid√©r√© comme "@mixed"</span></span>
    
    public function __construct(array $bar) {
        $this->bar = $bar;
    }
    
    public function getBar() {
        return strtoupper($this->bar);
    }
}

$foo = new Foo(['io']);
$foo->getBar();</code></pre>
                        <div class="fragment success" data-fragment-index="1">
                            [OK] No errors
                        </div>
                        <div class="fragment error" data-fragment-index="2">
PHP Warning:  strtoupper() expects parameter 1 to be string, array given
                        </div>
                        <aside class="notes">
                            PHPStan ne va pas vous remonter d'erreur car $bar est consid√©r√© comme `mixed`
                        <aside>
                    </section>

                    <section id="typed-property">
                        <pre><code class="hljs php" data-trim data-noescape>class Foo {
    /**
     * @var <span class="fragment highlight-red" data-fragment-index="1">array</span>
     */
    private $bar;
    
    public function __construct(array $bar) {
        $this->bar = $bar;
    }
    
    public function getBar() {
        return <span class="fragment highlight-red" data-fragment-index="1">strtoupper($this->bar)</span>;
    }
}

$foo = new Foo(['io']);
$foo->getBar();</code></pre>
                        <div class="fragment error" data-fragment-index="1">
                            [ERROR] Parameter #1 $str of function strtoupper expects string, array given.
                        </div>
                        <aside class="notes">
                            Par contre si $bar est typ√© comme un tableau, alors l√† vous allez avoir une erreur.
                        <aside>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Les erreurs "de compilation"</h2>
                    </section>

                    <section id="compile-errors">
                        <pre><code class="hljs php" data-trim data-noescape>function sayHello(<span class="fragment highlight-red" data-fragment-index="1">string</span> $who): string {
    return 'Hello ' . strtoupper($who);
}

$julien = new User('julien');

sayHello($julien);
                        </code></pre>

                        <div class="fragment error" data-fragment-index="1">
                            [ERROR] Parameter #1 $who of function sayHello expects string, User given.
                        </div>
                    </section>

                    <section id="wrong-interface-call">
                        <h4>Mauvaise fonction appel√©e</h4>
                        <pre><code class="hljs php" data-trim data-noescape>interface FooInterface {}

class Foo implements FooInterface {
  public function bar() {
    // do stuff
  }
}

function dumpFoo(FooInterface $fooInterface) {
  <span class="fragment highlight-red" data-fragment-index="1">return  $fooInterface->bar();</span>
}

$foo = new Foo();
dumpFoo($foo);</code></pre>

                        <div class="fragment error" data-fragment-index="1">
                            [ERROR] Call to an undefined method FooInterface::bar().
                        </div>

                        <aside class="notes">
                            Il sait tr√®s bien remonter des erreurs quand vous appelez des fonctions qui ne sont pas d√©finit dans une interface par exemple.

                            <br />
                            <br />
                            L√† l'exemple parait "bidon" car il est simplifi√©, mais il est probable que vous ayez ce genre de cas dans votre code
                        <aside>
                    </section>

                    <section id="wrong-interface-call-doctrine">
                        <h4>Mauvaise fonction appel√©e</h4>
                        <pre><code class="hljs php" data-trim>use Doctrine\Common\Persistence\ObjectManager;

function doStuff(ObjectManager $entityManager)
{
  return $entityManager->createQueryBuilder()
    ->from('SomeEntity', 'a')
    ->where('a.id = 8')
    ->getResult();
}</code></pre>
                        <div class="fragment">
                            Un <code>ObjectManager</code> n'a pas de m√©thode <code>createQueryBuilder</code>.<br />
                            Cette m√©thode fait partie de <code>Doctrine\ORM\EntityManagerInterface</code>
                        </div>

                        <aside class="notes">
                            C'est nettement moins trivial quand on utilise une librairie externe, Doctrine par exemple.<br />
                            ou bien un code m√©tier complexe.
                            <br /><br />
                            Le fait d'avoir un code "propre" vous permettra de "changer" des choses tr√®s facilement, sans avoir √† (re)comprendre des tests
                        <aside>
                    </section>
                </section>

                <section>
                    <section id="keep-your-code-clean">
                        <h2>Garder son code propre</h2>
                    </section>
                    <section>
                        <h4>Tests inutiles</h4>
                        <pre><code class="hljs php" data-trim data-noescape>class Foo { public $id = 1; }

function getFoo(): Foo
{
  return new Foo();
}

$foo = getFoo();

<span class="fragment highlight-red" data-fragment-index="1">if ($foo) {</span>
  var_dump($foo->id);
<span class="fragment highlight-red" data-fragment-index="1">}</span>
                        </code></pre>
                        <div class="fragment error"  data-fragment-index="1">
                            [ERROR] If condition is always true.
                        </div>
                        <aside class="notes">
                            En parlant de code "propre", il est possible que vous ayez d√©j√† rencontr√© ce genre de code.
                            <br />
                            On peut faire ce genre de test parce que "comme √ßa on est sur" ou bien simplement parce que `getFoo` pouvait retourner `null` avant, mais ce n'est plus le cas.
                            <br />
                            PHPStan va ici vous aider √† garder votre code propre en √©vitant les tests inutiles
                        </aside>
                    </section>
                    <section id="casting">
                        <h4>Conversions inutiles...</h4>
                        <pre><code class="hljs php" data-trim data-noescape>$a = (int) 8 % 3; </code></pre>
                        <div class="error">
                            [ERROR] Casting to int something that's already int.
                        </div>
                        <div class="fragment">
                        <h4>...ou requise !</h4>
                        <pre><code class="hljs php" data-trim data-noescape>function div(int $a, int $b): int {
    return round($a / $b);
}</code></pre>
                        <div class="error">
                            [ERROR] Function div() should return int but returns float.
                        </div>
                        </div>

                        <aside class="notes">
                            On √©vite aussi de caster inutilement.<br />
                            Ou de ne pas caster quand c'est requis !
                        </aside>

                    </section>
                </section>

                <section>
                    <section>
                        <h2>
                            Eviter les fautes de frappe
                        </h2>
                    </section>
                    <section id="mangopay">
                        <pre><code class="hljs php" data-trim data-noescape>// librairie externe
namespace MangoPay;
class Address {
    public $City;
}

class UserLegal {
    public $Headquarte<span class="fragment highlight-red" data-fragment-index="1">rs</span>Address;
}

// code m√©tier
$tmp = new \MangoPay\UserLegal();
$tmp->Headquarte<span class="fragment highlight-red" data-fragment-index="1">r</span>Address = new \MangoPay\Address();
$tmp->Headquarte<span class="fragment highlight-red" data-fragment-index="1">r</span>Address->City = 'Lyon';
                        </code></pre>

                        <div class="fragment error"  data-fragment-index="1">
                            [ERROR] Access to an undefined property MangoPay\UserLegal::$HeadquarterAddress.
                        </div>

                        <aside class="notes">
                            On √©vite les fautes de frappe aussi :<br />
                            PHP permet d'ajouter a la vol√©e des propri√©t√©s √† un objet en publique et n'envoie m√™me pas de warning<br />
                            Un exemple avec de vrai code trouv√© chez nous !<br />
                            Du coup on a perdu quelques donn√©es non enregistr√©e
                        </aside>
                    </section>

                    <section id="get-an-array">
                        <pre><code class="hljs php" data-trim data-noescape>function getAnArray(iterable $iterable) : array
{
    $anArray = [];
    
    foreach ($iterable as $item) {
        $<span class="fragment highlight-red" data-fragment-index="1">get</span>AnArray[] = $item;
    }
    
    return $anArray;
}</code></pre>

                        <div class="fragment error" data-fragment-index="1">
                            Implicit array creation is not allowed - variable $getAnArray might not exist.
                        </div>

                        <aside class="notes">
                            Une variable mal nom√©e !<br />
                            Pour info, php cr√©e automatiquement un nouveau tableau<br />
                            sous la variable `$getAnArray`
                        </aside>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>
                            PHP++
                        </h2>
                    </section>
                    <section id="php-plus-plus">
                        <h4>Docstring</h4>
                        <pre><code class="hljs php" data-trim data-noescape>/**
 * @param array&lt;int&gt; $anArrayOfInt
 */
function doStuff(array $anArrayOfInt) {
  foreach ($anArrayOfInt as $anInt) {
    echo strtoupper($anInt);
  }
}</code></pre>

                        <div class="error" data-fragment-index="1">
                            Parameter #1 $str of function strtoupper expects string, int given.
                        </div>

                        <aside class="notes">
                            La docstring permet de donner plus de d√©tail que le language ne sait pas traiter
                        </aside>
                    </section>

                    <section id="multiple-types">
                        <h4>Types multiples</h4>
                        <pre><code class="hljs php" data-trim data-noescape>use Doctrine\Common\Persistence\Collections\Collection;
	
/**
 * @var array&lt;int&gt;|Collection&lt;int&gt; $var
 */
function doStuff($var) {
  if ($var instanceof Collection) {
    $var = $var->toArray();
  }
  
  // `$var` sera reconnu comme un tableau de int
  <!--// `$var` will be known  as an array of int-->
}</code></pre>

                        <aside class="notes">
                            Ou bien m√™me de g√©rer des types diff√©rents
                        </aside>
                    </section>

                    <section id="covariance">
                        <h4>Covariance</h4>
                        <h5>PHP 7.4+</h5>
                        <pre><code class="hljs php" data-trim data-noescape>interface Factory {
    function make(): object;
}

class UserFactory implements Factory {
    function make(): User;
}</code></pre>
                        <h5>En attendant</h5>
                        <pre><code class="hljs php" data-trim data-noescape>class UserFactory implements Factory {
    /**
     * @return User
     */
    function make(): object;
}</code></pre>

                        <a href="https://wiki.php.net/rfc/covariant-returns-and-contravariant-parameters"
                           target="_blank"
                           rel="noopener noreferer">
                            üîó RFC Covariance / contravariance
                        </a>

                        <aside class="notes">
                            Covariance : type de retour plus pr√©cis (User &gt; object)<br />
                            Contravariance : param√®tre d'entr√©e plus "large" que celui de l'interface
                        </aside>
                    </section>
                </section>

                <section id="benefits">
                    <section>
                        <h2>
                            Validation graduelle
                        </h2>

                        <h5>
                            Niveau de 0 √† 7 + r√®gles additionelles
                        </h5>
                    </section>

                    <section>
                        <h2>
                            PHPStan est rapide
                        </h2>

                        <h5>
                            700 fichiers en 30 secondes
                        </h5>
                    </section>

                    <section>
                        <h5>
                            Rien √† faire de plus que d'√©crire et (bien) documenter votre code
                        </h5>
                    </section>
                </section>

                <section id="concurrents">
                    <h2>Concurrence ?</h2>
                    <p>
                        <img data-src="/images/GitHub-Mark.png" width="50px" class="image-like-text" />
                        <a href="https://github.com/vimeo/psalm" rel="noopener noreferer" target="_blank">
                            vimeo/psalm
                        </a>
                    </p>

                    <p>
                        <img data-src="/images/GitHub-Mark.png" width="50px" class="image-like-text" />
                        <a href="https://github.com/phan/phan" rel="noopener noreferer" target="_blank">
                            phan/phan
                        </a>
                    </p>

                    <h5>
                        Lequel utiliser ?
                    </h5>
                    <p>
                        <a href="https://badootech.badoo.com/php-code-static-analysis-based-on-the-example-of-phpstan-phan-and-psalm-a20654c4011d"
                            rel="noopener noreferer"
                            target="_blank"
                        >
                            Comparatif par Badoo tech
                        </a>
                    </p>

                        <aside class="notes">
                            <li>PHPStan : rapide, simple, fonctionne bien avec Doctrine, Symfony, etc.
                            <li>Phan : tr√®s efficace, mais peut donner des faux positifs, parse toute la base de code
                            <li>Psalm : Typage avanc√© (types "generiques")
                        </aside>
                </section>

                <section id="quotes">
                    <section>
                        <h1>
                            Citations
                        </h1>
                    </section>

                    <section>
                        <blockquote>
                            ‚Ä¶ chiant au d√©but quand on connait pas [‚Ä¶] un peu comme quand tu d√©couvres les tests :<br />
                            puis quelques mois apr√®s tu lances des deploy en sirotant un petit kir cassis‚Ä¶
                        </blockquote>
                    </section>
                    <section>
                        <blockquote>
                            ‚Ä¶un peu contraignant mais si on p√®se le pour et le contre √ßa en vaut le d√©tour. <br />
                            L'investissement valait le coup, le code est plus propre‚Ä¶
                        </blockquote>
                    </section>

                </section>

                <section id="questions">
                    <h2>
                        Des questions ?
                    </h2>
                </section>
            </div>
        </div>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>

        <script>
// More info about config & dependencies:
// - https://github.com/hakimel/reveal.js#configuration
// - https://github.com/hakimel/reveal.js#dependencies
Reveal.configure({
    slideNumber: 'c/t',
});

function ready(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading"){
        fn();
    } else {
        document.addEventListener('DOMContentLoaded', fn);
    }
}

Reveal.initialize({

    dependencies: [
        { src: 'plugin/markdown/marked.js' },
        { src: 'plugin/markdown/markdown.js' },
        { src: 'plugin/notes/notes.js', async: true },
        {
            src: 'plugin/highlight/highlight.js',
            async: true,
            callback: function() {
                ready(function() {
                    hljs.initHighlighting();

                    // // Rebuild ...
                    // var pre = document.querySelectorAll('pre'),
                    //     code, data, html;

                    // for (var i = 0, len = pre.length; i < len; ++i) {
                    //     code = pre[i].firstChild;
                    //     if (/(^| )hljs( |$)/.test(code.className)) {
                    //         data = code.innerHTML;
                    //         html = '<code class="' + code.className + '">' + data + '</code>';
                    //         html += '<span class="line-number-clear"></span>';
                    //         pre[i].innerHTML = html;
                    //     }
                    // }
                })
            }
        },
        {
            src: 'node_modules/twemoji/2/twemoji.min.js',
            async: true,
            callback: function() {
                twemoji.base = './node_modules/twemoji/2/';
                twemoji.ext = '.svg';
                twemoji.size = 'svg';
                twemoji.parse(document.body);
            },
        },
    ]
});
        </script>
    </body>
</html>
